# 🏗️ 一日一善アプリ - 全体構造概要

## 📱 アプリ構成概要（フロントエンド視点）

```
┌─────────────────────────────────────────────────────────────┐
│                    🌐 ユーザーのブラウザ                     │
├─────────────────────────────────────────────────────────────┤
│  📱 Next.js 15 フロントエンド (src/app/)                   │
│  ├── 🔐 認証管理 (Firebase Auth + 状態管理)                │
│  ├── 📄 ページ (App Router)                               │
│  ├── 🎨 コンポーネント (React 19)                         │
│  ├── 🗂️ 状態管理 (Zustand + React Query)                  │
│  └── 🎯 API呼び出し (認証ヘッダー付き)                      │
├─────────────────────────────────────────────────────────────┤
│  🌐 Vercel Edge Functions (認証ミドルウェア)               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    🔥 Firebase認証基盤                      │
│  ├── 👤 Google/Apple/匿名ログイン                          │
│  ├── 🔑 JWT トークン発行・検証                             │
│  └── 🛡️ セキュリティルール                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    📊 データ層                              │
│  ├── 🔥 Firestore (リアルタイムデータ)                     │
│  ├── 🐘 PostgreSQL (分析データ)                           │
│  └── 🔴 Redis (キャッシュ・セッション)                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔐 認証フロー詳細（実装の流れ）

### 1️⃣ ログインフロー
```
👤 ユーザー
    │
    ▼ (1) ログインボタンクリック
┌─────────────────┐
│ 🎨 LoginForm    │ ← src/components/auth/LoginForm.tsx
│ Component       │
└─────────────────┘
    │
    ▼ (2) Firebase Auth呼び出し
┌─────────────────┐
│ 🔥 Firebase     │ ← lib/firebase.ts
│ signIn()        │
└─────────────────┘
    │
    ▼ (3) トークン取得・状態更新
┌─────────────────┐
│ 🗂️ Zustand      │ ← stores/authStore.ts
│ ユーザー状態    │
└─────────────────┘
    │
    ▼ (4) UI更新・リダイレクト
┌─────────────────┐
│ 📱 アプリ画面    │ ← app/dashboard/page.tsx
│ (認証済み)      │
└─────────────────┘
```

### 2️⃣ API呼び出し時の認証
```
📱 React Component
    │
    ▼ (1) API呼び出し
┌─────────────────┐
│ 🔧 API Client   │ ← lib/api-client.ts
│ (React Query)   │
└─────────────────┘
    │
    ▼ (2) 認証ヘッダー自動付与
┌─────────────────┐
│ 🛡️ Middleware   │ ← middleware.ts
│ JWT検証         │
└─────────────────┘
    │
    ▼ (3) データ取得・返却
┌─────────────────┐
│ 📊 Database     │
│ Response        │
└─────────────────┘
```

---

## 📁 ディレクトリ構造（認証関連）

```
src/
├── app/
│   ├── (auth)/                    # 認証関連ページグループ
│   │   ├── login/page.tsx         # ログインページ
│   │   ├── register/page.tsx      # 新規登録ページ
│   │   └── layout.tsx             # 認証レイアウト
│   │
│   ├── (protected)/               # 認証必須ページグループ  
│   │   ├── dashboard/page.tsx     # ダッシュボード
│   │   ├── profile/page.tsx       # プロフィール
│   │   └── layout.tsx             # 認証済みレイアウト
│   │
│   └── api/                       # API Routes
│       ├── auth/                  # 認証API
│       └── user/                  # ユーザーAPI
│
├── components/
│   ├── auth/                      # 認証コンポーネント
│   │   ├── LoginForm.tsx          # ログインフォーム
│   │   ├── RegisterForm.tsx       # 登録フォーム
│   │   ├── AuthProvider.tsx       # 認証プロバイダー
│   │   └── ProtectedRoute.tsx     # 認証保護
│   │
│   └── ui/                        # 基本UIコンポーネント
│       ├── Button.tsx
│       ├── Input.tsx
│       └── Card.tsx
│
├── hooks/                         # カスタムフック
│   ├── useAuth.ts                 # 認証フック
│   ├── useUser.ts                 # ユーザー情報フック
│   └── useProtectedRoute.ts       # 認証保護フック
│
├── stores/                        # 状態管理
│   ├── authStore.ts               # 認証状態
│   └── userStore.ts               # ユーザー状態
│
├── lib/                           # ユーティリティ
│   ├── firebase.ts                # Firebase設定
│   ├── api-client.ts              # API客端
│   └── auth.ts                    # 認証ヘルパー
│
├── types/                         # 型定義
│   ├── auth.ts                    # 認証関連型
│   └── user.ts                    # ユーザー関連型
│
└── config/                        # 設定
    ├── firebase.ts                # Firebase設定
    └── auth.ts                    # 認証設定
```

---

## 🎯 Phase 2 実装計画

### 2.1 Firebase認証セットアップ ⏱️ 30分 ✅ 完了
- [x] Firebase プロジェクト作成・設定
- [x] 認証方法設定（Google/Email）
- [x] 環境変数設定

### 2.2 認証基盤実装 ⏱️ 1時間 ✅ 完了
- [x] Firebase SDK設定
- [x] 認証状態管理（Zustand）
- [x] 認証フック作成

### 2.3 認証UI実装 ⏱️ 1.5時間 ✅ 完了
- [x] ログイン・登録フォーム
- [x] 認証保護コンポーネント
- [x] レスポンシブデザイン
- [x] SSRエラー解決

### 2.4 認証機能テスト ⏱️ 30分 🔄 進行中
- [x] 新規登録ページ作成
- [x] メール認証確認画面作成
- [x] 新規登録フロー修正（メール認証対応）
- [x] 無限リダイレクト問題修正
- [x] Firebase sendEmailVerification修正
- [x] 認証状態管理改善
- [ ] アカウント作成テスト
- [ ] メール/パスワードログインテスト
- [ ] Googleログインテスト
- [ ] メール認証フローテスト
- [ ] ダッシュボードアクセステスト
- [ ] ログアウト機能テスト

### 2.5 セキュリティ強化 ⏱️ 1時間
- [ ] JWT検証ミドルウェア
- [ ] レート制限実装
- [ ] CSRF対策

### 2.6 テスト・統合 ⏱️ 30分
- [ ] エラーハンドリング強化
- [ ] ユーザー体験最適化

---

## 🛠️ 使用技術スタック（認証）

```typescript
// 主要な技術
interface AuthTechStack {
  authentication: 'Firebase Auth v9';     // 認証基盤
  stateManagement: 'Zustand v5';          // 状態管理  
  apiClient: 'React Query v5';            // サーバー状態
  validation: 'Zod v3';                   // バリデーション
  forms: 'React Hook Form v7';            // フォーム管理
  ui: 'Tailwind CSS + Radix UI';          // UIライブラリ
  security: 'Next.js Middleware';         // セキュリティ
}
```

---

## 📋 今回実装する機能

### ✅ ユーザーができること
- 🔐 **Google/Apple/匿名でログイン**
- 📝 **プロフィール設定・更新**  
- 🔄 **自動ログイン（リフレッシュ）**
- 🔒 **セキュアなログアウト**
- 📱 **レスポンシブ認証UI**

### 🛡️ セキュリティ機能
- 🔑 **JWT トークン検証**
- 🚦 **レート制限**
- 🛡️ **CSRF攻撃対策**
- 🔐 **XSS攻撃対策**
- 📊 **認証ログ記録**

**準備はいいですか？まずFirebase認証のセットアップから開始しましょう！** 🚀 

## 📱 モバイルアプリ配信戦略

### 技術選択: PWA → Capacitor → ネイティブアプリ

```
┌─────────────────────────────────────┐
│  🌐 Phase 1: PWA Web版              │
│  - Next.js + Firebase              │
│  - ブラウザ配信                      │
│  - 機能開発・テスト                  │
└─────────────────────────────────────┘
                 │
                 ▼ Capacitor導入
┌─────────────────────────────────────┐
│  📱 Phase 2: ネイティブアプリ         │
│  - 既存コード100%活用                │
│  - App Store/Google Play配信        │
│  - ネイティブ機能追加                │
└─────────────────────────────────────┘
                 │
                 ▼ 必要に応じて
┌─────────────────────────────────────┐
│  🚀 Phase 3: 完全ネイティブ          │
│  - React Native移行                │
│  - 最高パフォーマンス                │
│  - 高度なネイティブ機能              │
└─────────────────────────────────────┘
```

### Capacitor導入準備事項
- [ ] PWA manifest.json設定
- [ ] アイコン・スプラッシュ画像準備
- [ ] App Store/Google Play開発者登録
- [ ] アプリ配信戦略策定

--- 